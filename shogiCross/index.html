<!DOCTYPE html>
<html>
	<head>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-46760069-2"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'UA-46760069-2');
		</script>

		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="viewport" content="width=device-width" />
		<title>ShogiCross</title>
		<link rel=icon href="../favicon.ico">
		<link href="../gspec24.css" rel="stylesheet">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Kosugi&family=Noto+Serif+JP:wght@900&family=Noto+Serif+TC:wght@900&family=Noto+Serif:wght@900&display=swap" rel="stylesheet">
		<style>
			body {
				font-family:"Noto Serif JP","Noto Serif TC","Noto Serif",serif;
				font-weight: 900;
				line-height: 1.3em;
			}
			input, select, option, textarea {
				font-family:"Noto Serif JP","Noto Serif TC","Noto Serif",serif;
				line-height: 1em;
			}
		</style>
	</head>
	<body>
		<h1>ShogiCross</h1>
		<div class="flex-col">
			<div class="flex-row">
				<div style="">
					<canvas id="shogiCross"></canvas>
				</div>
				<div>
					<select id="selectGame"></select>
					<div id="crossGame" class="flex-row" style="display:none">
						<div class="flex-col">
							<select id="selectBoard"></select>
							<select id="selectStand">
								<option value="true">駒台あり</option>
								<option value="false">駒台なし</option>
							</select>
						</div>
						<div class="flex-col">
							<select class="selectPieces"></select>
							<select class="selectPiecesOther"></select>
						</div>
						<div class="flex-col">
							<select class="selectPieces"></select>
							<select class="selectPiecesOther"></select>
						</div>
						<div class="flex-col">
							<select class="selectPieces"></select>
							<select class="selectPiecesOther"></select>
						</div>
						<div class="flex-col">
							<select class="selectPieces"></select>
							<select class="selectPiecesOther"></select>
						</div>
					</div>
					<div><textarea id="shogiCrossText"></textarea></div>
					<div><textarea id="shogiCrossTextMini"></textarea></div>
				</div>
			</div>
			<div class="flex-col">
				駒を自由に並べ替えたりできるやつ。CPUやゲームルールは実装されていません。
				<a href="./pieceViewer.html">PieceViewer</a>
				<a href="https://github.com/yosgspec/ShogiCross">GitHub</a>
				<a href="https://github.com/yosgspec/ShogiCross/blob/main/other/paperPiece.pdf">印刷用駒</a>
				<a href="http://yosgspec.blog103.fc2.com/blog-entry-2997.html">超棋(過去制作物)</a>
				<a href="/">TOP</a>
			</div>
		</div>

		<script type="module">
		import {boards, games} from "./ShogiCross/lib.js"
		import {PlayGame} from "./game/playGame.js";
		const selectGame = document.getElementById("selectGame");
		const crossGame = document.getElementById("crossGame");
		const selectBoard = document.getElementById("selectBoard");
		const selectStand = document.getElementById("selectStand");
		const selectPieces = document.querySelectorAll(".selectPieces");
		const selectPiecesOther = document.querySelectorAll(".selectPiecesOther");
		const canvas = document.getElementById("shogiCross");
		const txt = document.getElementById("shogiCrossText");
		const txtMini = document.getElementById("shogiCrossTextMini");

		// セレクトボックス
		const getSelects = ()=>({
			playBoard: selectBoard.value,
			useStand: JSON.parse(selectStand.value),
			playPieces: [...selectPieces].map((pieces, i)=>({
				game: pieces.value,
				other: selectPiecesOther[i].value
			}))
		});

		// 実行中のゲーム
		let playingGame;

		// セレクトボックスに追加
		Object.entries(PlayGame).forEach(([key, {name}])=>{
			const opt = document.createElement("option");
			opt.value = key;
			opt.textContent = name;
			selectGame.appendChild(opt);
			//if(key === "p4CrossOver9") opt.selected = true;
		});

		/** クロスセレクトメニュー */
		function changeCrossGame(){
			if(selectGame.value !== "cross"){
				crossGame.style.display = "none";
				return;
			}
			// ボード一覧を初期化
			crossGame.style.display = "";
			selectBoard.innerHTML = "";
			Object.keys(boards).forEach(boardName=>{
				const opt = document.createElement("option");
				opt.value = opt.textContent = boardName;
				selectBoard.appendChild(opt);
			});
			selectPieces.forEach((ele, i)=>{
				ele.innerHTML = "";
				const opt = document.createElement("option");
				opt.value = "";
				opt.textContent = `--駒${i+1}--`;
				ele.appendChild(opt);
				Object.entries(games).forEach(([key, game])=>{
					const opt = document.createElement("option");
					opt.value = opt.textContent = key;
					ele.appendChild(opt);
				});
			});
		}

		/** クロス駒配置パターン */
		function changeCrossPiece(piecesName, i){
			const game = selectPieces[i];
			const other = selectPiecesOther[i];
			return function(){
				other.innerHTML = "";
				if(!games[game.value]) return;
				const xLen = boards[selectBoard.value].field[0].length;
				if(!games[game.value].position[xLen]) return;
				Object.keys(games[game.value].position[xLen]).forEach(key=>{
					const opt = document.createElement("option");
					opt.value = opt.textContent = key;
					other.appendChild(opt);
				});
			}
		}

		/** 描写イベント
		 * {board} e
		 */
		function onDrawed(e){
			txt.value = ""+e;
			const txtSplit = txt.value.split(/\n/);
			const fontSize = parseFloat(window.getComputedStyle(txt, null).getPropertyValue('font-size'));
			txt.style.width = `${0|fontSize*txtSplit[0].length*1.15}px`;
			txt.style.height = `${0|fontSize*txtSplit.length*1.1}px`;
			txtMini.value = e.toString(true);
			const txtMiniSplit = txtMini.value.split(/\n/);
			txtMini.style.width = `${0|fontSize*txtMiniSplit[0].length*1.2}px`;
			txtMini.style.height = `${0|fontSize*txtMiniSplit.length*1.2}px`;
		};

		/** テキスト更新イベント
		 * {any} target - HTMLElement
		 */
		function txtOnChange({target}){
			playingGame.inputPieces(target.value);
		};

		/** ゲームを実行 */
		async function playGame(){
			playingGame?.close();
			playingGame = PlayGame[selectGame.value].run(canvas, onDrawed, getSelects());
			txt.onchange = txtOnChange;
			txtMini.onchange = txtOnChange;
		};

		(function(){
			playGame();
			selectGame.addEventListener("change", changeCrossGame);
			selectGame.addEventListener("change", playGame);
			selectBoard.addEventListener("change", playGame);
			selectStand.addEventListener("change", playGame);
			selectPieces.forEach((p, i)=>{
				selectPieces[i].addEventListener("change", changeCrossPiece(p.value, i));
				selectPieces[i].addEventListener("change", playGame);
				selectPiecesOther[i].addEventListener("change", playGame);
			})
		})();
		</script>
	</body>
</html>
