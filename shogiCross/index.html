<!DOCTYPE html>
<html>
	<head>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-46760069-2"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'UA-46760069-2');
		</script>

		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="viewport" content="width=device-width" />
		<title>ShogiCross</title>
		<link rel=icon href="../favicon.ico">
		<link href="../gspec24.css" rel="stylesheet">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@900&display=swap" rel="stylesheet">
		<style>
			body {
				font-family:"Noto Serif JP",serif;
				font-weight: 900;
				line-height: 1.3em;
			}
			input, select, option, textarea {
				font-family:"Noto Serif JP",serif;
				line-height: 1em;
			}
		</style>
	</head>
	<body>
		<div class="flex-col">
			<canvas id="shogiCross"></canvas>
			<div class="flex-row">
				<select id="selectGame"></select>
				<select id="selectVariant"></select>
				<button id="downloadImage">画像を保存</button>
			</div>
			<div id="crossSelects" class="flex-row" style="display:none">
				<div class="flex-col-fit">
					<select id="selectBoard"></select>
					<select id="selectStand">
						<option value="true">駒台あり</option>
						<option value="false">駒台なし</option>
					</select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
				</div>
			</div>
			<details>
				<summary style="cursor:pointer;">棋譜</summary>
				<textarea id="shogiCrossRecord" style="height:100px;overflow-y:scroll;" readonly></textarea>
			</details>
			<details>
				<summary style="cursor:pointer;">テキスト形式表示</summary>
				テキストを直接書き換えて駒配置を直接編集できます。<br>
				配置可能な駒は<a href="https://github.com/yosgspec/ShogiCross/blob/main/doc/pieces/README.md">駒情報表</a>を参照してください。<br>
				<div class="flex-row">
					<textarea id="shogiCrossText"></textarea>
					<textarea id="shogiCrossTextMini"></textarea>
				</div>
			</details>
			<details>
				<summary style="cursor:pointer;">BOD形式表示</summary>
				<textarea id="shogiCrossBod" style="font-family:monospace; width:500px; height:20em;" readonly></textarea>
			</details>
		</div>
		<div class="flex-col">
			<h1>将棋クロス【ShogiCross】</h1>
			駒を自由に並べ替えたりできるやつ。<br>
			CPUや駒の移動範囲表示以外のゲームルールは未実装。
			<img src="./img/logo.min.svg">
			<a href="./pieceViewer.html">PieceViewer</a>
			<a href="./playBoard.html">将棋類紹介</a>
			<a href="./simple/">ゲーム単品集</a>
			<a href="https://github.com/yosgspec/ShogiCross">GitHub(ライブラリ配布、ペーパークラフト)</a>
			<a href="http://yosgspec.blog103.fc2.com/blog-entry-2997.html">超棋(過去制作物)</a>
			<a href="/">TOP</a>
		</div>

		<script type="module">
		import {PlayGames} from "./game/playGame.js";
		import {SelectControl} from "./game/selectControl.js";
		const canvas = document.getElementById("shogiCross");
		const downloadImage = document.getElementById("downloadImage");
		const txt = document.getElementById("shogiCrossText");
		const txtMini = document.getElementById("shogiCrossTextMini");
		const bod = document.getElementById("shogiCrossBod");
		const record = document.getElementById("shogiCrossRecord");

		/** 描写イベント
		 * {board} e
		 */
		function onDrawed(e){
			record.value = e.getTextRecord();
			record.scrollTop = record.scrollHeight;
			txt.value = ""+e;
			const txtSplit = txt.value.split(/\n/);
			const fontSize = parseFloat(window.getComputedStyle(txt, null).getPropertyValue('font-size'));
			txt.style.width = `${0|fontSize*txtSplit[0].length*1.15}px`;
			txt.style.height = `${0|fontSize*txtSplit.length*1.1}px`;

			txtMini.value = e.toString(true);
			const txtMiniSplit = txtMini.value.split(/\n/);
			txtMini.style.width = `${0|fontSize*txtMiniSplit[0].length*1.2}px`;
			txtMini.style.height = `${0|fontSize*txtMiniSplit.length*1.2}px`;

			bod.value = e.bodText;
		};

		/** テキスト更新イベント
		 * {any} target - HTMLElement
		 */
		function txtOnChange({target}){
			playingGame.inputPieces(target.value);
		};

		/** 画像を保存ボタン */
		 function downloadImageClick(){
			playingGame.downloadImage(SelectControl.gameName);
		}

		// 実行中のゲーム
		let playingGame = {};

		/** ゲームを実行 */
		async function playGame(){
			if(playingGame.close) playingGame.close();
			playingGame = PlayGames[SelectControl.gameName].run(canvas, {onDrawed, ...SelectControl.options});
			downloadImage.onclick = downloadImageClick;
			txt.onchange = txtOnChange;
			txtMini.onchange = txtOnChange;
		};

		(function(){
			playGame();
			SelectControl.onchange = playGame;
		})();
		</script>
	</body>
</html>
