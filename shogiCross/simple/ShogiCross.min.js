let Z="./json/ShogiCross/";async function E(t){return await fetch(`./json/ShogiCross/${t}.json`).then(async t=>await t.json()).catch(()=>{})}let T=await E("canvasFont"),pt=await E("gameSoft"),N=await E("games"),B=await E("boards"),H=await E("panels"),X=await E("pieces"),_=await E("pieceRange"),tt=await E("pieceCost"),et=()=>[...new Set([...Object.values(H).map(({displayText:t})=>t).join("")+Object.values(X).map(({display:t})=>t?t.join(""):"").join("")])].sort().join("");function st(t){return new Promise(e=>{let i=new Image;i.src=t,i.onload=()=>e(i)})}Object.assign(T,{imported:!1,names:"",async importAsync(){if(this.imported)return;let t=et(),e=new Date().getTime().toString();return this.names=T.fonts.map(t=>`"${t[0]}${e}"`).join(",")+",serif",Promise.all(T.fonts.map(async([i,s])=>{let r=i.replace(/ /g,"+"),a=`https://fonts.googleapis.com/css2?family=${r}:wght@${s}&text=${t}`,o=await fetch(a);if(!o.ok)return;let h=(await o.text()).match(/url\(.+?\)/g);if(!h)throw Error("Not found font.");for(let n of h){let l=new FontFace(`${i}${e}`,n);document.fonts.add(l),await l.load().catch(()=>{})}})).then(t=>this.imported=!0)}});let it=[...new Set(Object.values(H).flatMap(({imgSrc:t})=>t??[]).concat(Object.values(X).flatMap(({imgSrc:t})=>t??[])))],I={imported:!1,images:{},async importAsync(){if(!this.imported)return Promise.all(it.map(async t=>{this.images[t]=await st(t)})).then(t=>this.imported=!0)}},rt=t=>"image/"+t.replace("jpg","jpeg");async function ot(t,e="image",i="png",s="base64"){let r=rt(i),a=document.createElement("a"),o;o="blob"===s?URL.createObjectURL(await new Promise(e=>t.toBlob(e),r)):t.toDataURL(r),a.href=o,a.download=`${e}.${i}`,a.click(),"blob"===s&&URL.revokeObjectURL(a.href)}class x{static #a=new Map([[0," "],[90,">"],[180,"v"],[270,"<"]]);static #b=new Map([...x.#a].map(([t,e])=>[e,t]));static #c=new Map([[0,"先手の持駒："],[90,"次手の持駒："],[180,"後手の持駒："],[270,"四手の持駒："]]);static #d=new Map([...x.#c].map(([t,e])=>[e,t]));static #e(t,e=!0){return!e&&t<=1?"":["","十","二十","三十","四十","五十","六十","七十","八十","九十"][0|t/10]+["","一","二","三","四","五","六","七","八","九"][t%10]}static #f(i){return 10<=i?i:"０１２３４５６７８９"[i%10]}static #g=" ・";static #h(s){return s?x.#a.get(s.deg)+s.char:x.#g}static #i(r,a=0){let o=new Map;return r.stocks.get(a).forEach(({char:t})=>{o.has(t)||o.set(t,0),o.set(t,o.get(t)+1)}),x.#c.get(a)+[...o].map(([t,e])=>t+x.#e(e)).join(" ")}static getText(t){let{field:e,xLen:i,players:s,stand:r}=t,a=` ${[...Array(i).keys()].map(t=>` ${x.#f(i-t)}`).join("")}
+${Array(i).fill("---").join("")}+
`,o=`
+${Array(i).fill("---").join("")}+`,h=`
`,n=`${x.#i(r,180)}
`,l=`${x.#i(r,0)}`;return 2!==s&&(n=`${x.#i(r,270)}
`+n,l=`${x.#i(r,90)}
`+l),n+a+e.map((t,e)=>"|"+t.map(t=>x.#h(t.piece)).join("")+"|"+x.#e(e+1)).join(h)+`${o}
`+l}}class nt{#a;#b;constructor(t,e,i,s,r,a,o,h,n){Object.assign(this,H[e]),this.ctx=t,this.center=i,this.middle=s,this.width=r,this.height=a,this.left=i-r/2,this.top=s-a/2,this.right=i+r/2,this.bottom=s+a/2,this.borderWidth=o,this.pX=h,this.pY=n,this.selectColor??="#FF000066",this.targetColor??="#00FF0066",this.piece=null,this.isSelected=!1,this.clearTarget(),this.attr??=[]}set isSelected(t){this.#a=!this.hasAttr("keepOut")&&t}get isSelected(){return this.#a}get isTarget(){return 0<this.#b.length}clearTarget(){this.#b=[]}addTarget(t){this.#b.push(t)}hasTarget(t){return this.#b.includes(t)}hasAttr(t){return this.attr.includes(t)}checkRangeMouse(t,e){return this.left<=t&&t<this.right&&this.top<=e&&e<this.bottom}draw(){let{selectColor:t,targetColor:e}=this;this.drawPanel(),this.isSelected&&this.drawMask(t),this.isTarget&&this.drawMask(e),this.piece?.draw()}drawPanel(){let{ctx:t,left:e,top:i,center:s,middle:r,width:a,height:o,displayText:h,textRotate:n}=this;if(t.fillStyle=this.backgroundColor,t.strokeStyle=this.borderColor,t.lineWidth=this.borderWidth,t.save(),t.translate(e,i),t.fillRect(0,0,a,o),this.intersect?(t.lineWidth=this.borderWidth,t.beginPath(),t.moveTo(a/2,0),t.lineTo(a/2,o),t.moveTo(0,o/2),t.lineTo(a,o/2),t.closePath(),t.stroke()):t.strokeRect(0,0,a,o),t.lineWidth=this.borderWidth/2,t.beginPath(),this.borderSlashLeft&&(t.moveTo(0,0),t.lineTo(a,o)),this.borderSlashRight&&(t.moveTo(a,0),t.lineTo(0,o)),t.closePath(),t.stroke(),t.restore(),h){t.save(),t.translate(s,r),t.fillStyle=this.borderColor,t.rotate(n?n*Math.PI/180:0);let l=.6*Math.min(this.width,this.height);t.font=`${l}px ${T.names}`;let c=t.measureText(h).width;t.fillText(h,-c/2,l/2*.8),t.restore()}}drawMask(t){let{ctx:e}=this;e.fillStyle=t,e.fillRect(this.left,this.top,this.width,this.height)}toString(t=!1){return t?`｜${this.text.slice(-1).replace(/　/g,"・")}`:this.text}}class S{static size=45;static useRankSize=!0;static isDrawShadow=!0;static degChars={0:"▲",90:"≫",180:"▽",270:"＜"};static charDegs={};static rankRatio={KR:1,SR:.965,R:.935,UC:.9,C:.865};get rank(){return this.cost<=0?"KR":20<=this.cost?"SR":10<=this.cost?"R":5<=this.cost?"UC":"C"}static getPieces(t,e={}){let i=new Map(Object.entries(JSON.parse(JSON.stringify(X))));for(let[s,r]of i)r.attr??=[],r.unit&&"成"===r.unit&&(r.base=r);for(let[a,o]of i){if(!o.promo||"string"!=typeof o.promo)continue;let h=[...o.promo];for(let n of(o.promo={},h)){let l=i.get(n);l.attr.push("promoted"),l.unit="成",o.promo[n]=l,i.set(n,{...o,...l})}}[...i].forEach(([s,r],a)=>{r.id=a,r.char=s,i.set(s,new S(t,r,e))});let c=Object.fromEntries(i);for(let[d,g]of i)g.alias.forEach((t,e)=>{let i=g.clone(),s=[...i.display];i.displayPtn=e+1,i.display=s,i.alias[e]=d,c[t]=i});return c}static stringToPiece(t,e){if(!e)return null;let[i,s]=[...e],r=S.charDegs[i];if(!r)return null;let a=t[s].clone();return a.deg=r,a}static piecesToList(t){return Object.entries(t).sort(([t,{id:e}],[i,{id:s}])=>Math.sign(e-s))}set deg(t){this.rad=t%360*Math.PI/180}get deg(){return this.rad%360/(Math.PI/180)}get left(){return this.center-.8*this.size/2}get top(){return this.middle-this.size/2}get right(){return this.center+.8*this.size/2}get bottom(){return this.middle+this.size/2}get zoom(){let t=this.size/100;return this.useRankSize&&(t*=S.rankRatio[this.rank]),t}constructor(t,e,i={}){let{displayPtn:s=0,deg:r=0,size:a=S.size,useRankSize:o=S.useRankSize,isDrawShadow:h=S.isDrawShadow,isMoved:n=!1}=i;Object.assign(this,e),this.ctx=t,this.display??=[""],this.imgSrc??=null,this.alias=[...this.alias??""],this.displayPtn=s,this.game=N[this.gameName],this.cost=tt[this.char]??1,this.center=0,this.middle=0,this.deg=r,this.size=a,this.useRankSize=o,this.isDrawShadow=h,this.isRotateImg??=!0,this.isMoved=n,this.isSelected=!1,this.attr??=[];try{Object.entries(this.range).forEach(([t,e])=>{Array.isArray(e)||(this.range[t]=_[e].map(t=>[...t]))})}catch(l){throw console.error(l),e}}clone(){let{displayPtn:t,deg:e,size:i,isMoved:s}=this;return new S(this.ctx,{...this},{displayPtn:t,deg:e,size:i,isMoved:s})}turnFront(){Object.assign(this,this.base)}promotion(t){let{promo:e}=this;if(!e)throw Error(`promo=${t}, Not plomote piece.`);if(!e in e)throw Error(`promo=${t}, Plomote key is missing.`);if(this.hasAttr("promoted"))throw Error(`promo=${t}, Promoted piece.`);Object.assign(this,e[t]),this.char=t}hasAttr(t){return this.attr.includes(t)}checkRangeMouse(t,e){return this.left<=t&&t<this.right&&this.top<=e&&e<this.bottom}getRange(){let t=0|this.deg,e=JSON.parse(JSON.stringify(this.range));return Object.keys(e).forEach(i=>{if(0!==t){if(![90,180,270].includes(t))throw Error(`deg=${t}, deg need multiple of 90.`);if([90,270].includes(t)){var s;e[i]=(s=e[i])[0].map((t,e)=>s.map(t=>t[e]))}[180,270].includes(t)&&e[i].reverse(),e[i].forEach(e=>{[90,180].includes(t)&&e.reverse()})}}),e}async draw(){let t="#FF000055";this.imgSrc&&I.imported?(this.drawImage(),this.isSelected&&this.drawMaskImage(t)):(this.drawPiece(),this.isSelected&&this.drawMask(t))}drawImage(){let{ctx:t,size:e}=this,i=this.imgSrc[this.displayPtn],s=I.images[i];if(!s)return;t.save(),t.translate(this.center,this.middle),this.isRotateImg&&t.rotate(this.rad);let r,a;.9*s.width<s.height?(r=s.width/s.height*e,a=e):(r=e,a=s.height/s.width*e),t.drawImage(s,-r/2,-a/2,r,a),t.restore()}drawMaskImage(t){let{ctx:e,size:i}=this;e.fillStyle=t,e.save();let s=.9*i,r=i;e.translate(this.center,this.middle),e.fillRect(-s/2,-r/2,s,r),e.restore()}makePath(t){let{ctx:e}=this;e.translate(this.center,this.middle),e.rotate(this.rad),e.beginPath(),e.moveTo(-30*t,-40*t),e.lineTo(0*t,-50*t),e.lineTo(30*t,-40*t),e.lineTo(45*t,50*t),e.lineTo(-45*t,50*t),e.closePath()}drawPieceShadow(t){if(!this.isDrawShadow)return;let{ctx:e}=this;e.save(),e.translate(0,10*t),this.drawMask("#00000066"),e.restore()}drawPiece(){let{ctx:t,game:e,zoom:i}=this,s,r,a;this.hasAttr("promoted")?(s=e.promoteFontColor??e.fontColor??"#000000",r=e.promoteBackgroundColor??e.backgroundColor??"#FFFFFF",a=e.promoteBorderColor??e.borderColor??"#FF3300"):(s=e.fontColor??"#000000",r=e.backgroundColor??"#FFFFFF",a=e.borderColor??"#777777"),t.strokeStyle=a,t.fillStyle=r,t.lineWidth=8*i,this.drawPieceShadow(i),t.save(),this.makePath(i),t.stroke(),t.fill(),t.fillStyle=s;let o=[...""+this.display[this.displayPtn]],h=40*i;t.font=`${h}px ${T.names}`,t.textAlign="center",o.forEach((e,i)=>{let s=1===o.length?h/2:i*h;t.fillText(e,0,s)}),t.restore()}drawMask(t){let{ctx:e,zoom:i}=this;e.fillStyle=t,e.save(),this.makePath(i),e.fill(),e.restore()}getBodText(){return x.pieceDegChars[this.deg]+this.char}toString(){return S.degChars[this.deg]+this.char}}Object.entries(S.degChars).forEach(([t,e])=>{S.charDegs[e]=t});let at=[["default",{isAttack:!1}],["attack",{isAttack:!0}],["start",{isAttack:!1}],["castling",{isAttack:!1}],["enPassant",{isAttack:!0}],["palaceSlash",{isAttack:!1}],["palaceSlash",{isAttack:!0}]],ct=[["O",{isOwn:!0}],["o",{}]],ht=[["o"],["A",{child:["a"]}],["B",{child:["b"]}],["C",{child:["c"]}],["D",{child:["d"]}],["E",{child:["a","e"]}],["F",{child:["a","f"]}],["G",{child:["b","g"]}],["H",{child:["b","h"]}],["I",{child:["c","i"]}],["J",{child:["c","j"]}],["K",{child:["d","k"]}],["L",{child:["d","l"]}]],V=[["*",{}],["+",{jmps:1}],["|",{jmps:1,moves:1}]];for(let f=1;f<=9;f++)V.push([""+f,{moves:f}]);function lt(t){let e=[],i,s;for(let r=0;r<t.length;r++)for(let a=0;a<t[r].length;a++){let o=t[r][a];for(let[h,{isOwn:n}]of ct)o===h&&(e.push({isOwn:n,oX:a,oY:r}),n&&([i,s]=[a,r]))}return e.map(t=>(t.offsetX=t.oX-i,t.offsetY=t.oY-s,t))}function dt(t,e,i,s){let{field:r,yLen:a,enPassant:o}=t;function h(t,e){return r[e]&&r[e][t]&&!r[e][t].hasAttr("keepOut")}function n(t){return t.piece&&e.hasAttr("po")&&t.piece.hasAttr("po")}function l(h,l,c,d="",g=!0){var p;if(!r[c]||!r[c][l])return!1;let $=r[c][l];return!(!$||n($)||(p=$).piece&&!e.isMoved&&!p.piece.isMoved&&e.hasAttr("pao")&&e.cost<p.piece.cost||"enPassant"===d&&!o.isTarget($,e)||e.hasAttr("inPalace")&&!$.hasAttr("palace")||0===d.indexOf("palace")&&!($.hasAttr(d)&&r[s][i].hasAttr(d))||e.hasAttr("unCrossRiver")&&a-(0|a/2)<=t.getRow(l,c,e.deg))&&(h?!!r[c][l].piece&&(!g||e.deg!==r[c][l].piece.deg):!r[c][l].piece)}function c(t,e,r,a,o){for(let n of e)for(let c=0;c<t.length;c++)for(let d=0;d<t[c].length;d++){let[g,p]=[d+i-a,c+s-o];if(!(!h(g,p)||l(r,0|g,0|p,"",!1)||t[c][d]!==n))return!0}return!1}function d(t,i,s){let a=r[s][i];a.addTarget(t),o.setTarget(a,e)}function g(t,[e,{isAttack:r}],{oX:a,oY:o,isOwn:n}){if(n)for(let[g,{child:p=[]}={}]of ht)for(let $=0;$<t.length;$++)for(let m=0;m<t[$].length;m++){let[u,w]=[m+i-a,$+s-o];!h(u,w)||!l(r,u,w,e)||t[$][m]!==g||c(t,p,!1,a,o)||d(e,u,w)}}function p(t,[e,{isAttack:a}],{oX:o,oY:c,isOwn:g,offsetX:p,offsetY:$}){if(!(!g&&!l(!1,i+p,s+$)))for(let[m,{jmps:u=0,moves:w=0}={}]of V){let v=!w||0===w;for(let k=c-1;k<=c+1;k++)for(let y=o-1;y<=o+1;y++){if(t[k][y]!==m||y===o&&k===c)continue;let P=u||0,b=w||0,[R,C]=[y-o,k-c];for(let L=i,A=s;;){L+=R,A+=C;let M=L+p,j=A+$;if(!h(M,j)||!v&&0===b)break;let F=0===P;F&&l(a,M,j,e,F)?(b--,d(e,M,j)):u<1&&b--;let z=r[j][M];if(z.piece&&(P--,F||n(z)))break}}}}!function(){let t=e.getRange();for(let i of(t.attack??=t.default,at)){let s=i[0];if(e.isMoved&&["start","castling"].includes(s))continue;let r=t[s];if(r)for(let a of lt(r))g(r,i,a),p(r,i,a)}}()}function ft(t){let e=!1,i=[],s=null,r=null,{canvas:a}=t,o=(e,s,r=()=>{})=>{let o=window.getComputedStyle(a),h=e.target.getBoundingClientRect(),n=a.width/parseFloat(o.width),l=a.height/parseFloat(o.height);if(e.clientX)n*=e.clientX-h.left,l*=e.clientY-h.top;else if(0<e.touches.length){if(1<e.touches.length)return;n*=e.touches[0].clientX-h.left,l*=e.touches[0].clientY-h.top}else e.preventDefault(),[n,l]=i;t.field.forEach((t,e)=>t.forEach((t,i)=>s(t,n,l,i,e))),r(n,l),t.draw(),i=[n,l]},h=i=>{e=!0,o(i,(e,r,a)=>{let{piece:o,pX:h,pY:n}=e;o&&e.checkRangeMouse(r,a)&&(i.preventDefault(),o.isSelected=!0,s=e,dt(t,o,h,n))},(e,s)=>{for(let[a,o]of t.stand.stocks)for(let h=o.length-1;0<=h;h--)if(o[h].checkRangeMouse(e,s)){i.preventDefault(),o[h].isSelected=!0,r={deg:a,i:h};return}})},n=t=>{e&&(s||r)&&o(t,(t,e,i)=>{t.isSelected=t.checkRangeMouse(e,i)})},l=i=>{e=!1,o(i,(e,i,a)=>{e.checkRangeMouse(i,a)&&(s&&t.movePiece(s,e),r&&!e.piece&&t.stand.releasePiece(e,r))}),o(i,t=>{t.piece&&(t.piece.isSelected=!1),t.isSelected=!1,t.clearTarget()},()=>{for(let[e,i]of t.stand.stocks)for(let a=i.length-1;0<=a;a--)i[a].isSelected=!1;s=null,r=null})};return a.addEventListener("mousedown",h),a.addEventListener("mousemove",n),a.addEventListener("mouseup",l),a.addEventListener("touchstart",h),a.addEventListener("touchmove",n),a.addEventListener("touchend",l),{removeEvent(){a.removeEventListener("mousedown",h),a.removeEventListener("mousemove",n),a.removeEventListener("mouseup",l),a.removeEventListener("touchstart",h),a.removeEventListener("touchmove",n),a.removeEventListener("touchend",l)}}}class U{static #a=[180,90,270,0];constructor(t){this.board=t;let{top:e,right:i,bottom:s,width:r,height:a,panelWidth:o,panelHeight:h,xLen:n,yLen:l}=t;this.clear(),this.left=1.02*i,this.top=e,this.width=r/2,this.height=a,this.right=this.left+this.width,this.bottom=s,this.pitchWidth=o/2,this.pitchHeight=h,this.xLen=n,this.yLen=l}clear(){this.stocks=new Map(U.#a.map(t=>[t,[]]))}releasePiece(t,e={}){let{deg:i,i:s}=e,{board:r}=this,a=this.stocks.get(i);t.piece=a[s],a[s].center=t.center,a[s].middle=t.middle,r.addRecord(t,{end:"打"}),a.splice(s,1)}add(t){let e=this.stocks.get(t.deg);t.turnFront(),e.push(t),e.sort((t,e)=>Math.sign(t.id-e.id))}capturePiece(t,e,i=!1,s=!1){s||!e||!(i||t.hasAttr("capture"))||e.hasAttr("king")||e.hasAttr("cantCapture")||(e.deg=t.deg,e.isMoved=!0,this.add(e))}draw(){let{board:t,left:e,top:i,width:s,height:r,pitchWidth:a,pitchHeight:o}=this,{ctx:h,xLen:n,yLen:l}=t;h.fillStyle=t.backgroundColor,h.strokeStyle=t.borderColor,h.lineWidth=t.borderWidth,h.save(),h.translate(e,i),h.fillRect(0,0,s,r),h.strokeRect(0,0,s,r),h.restore(),[...this.stocks.values()].forEach((t,s)=>{let r=0;t=t.slice(-l/4*n);for(let h=0|l/4*s;h<l/4*(s+1);h++)for(let c=0;c<n;c++){let d=e+a*(c+1),g=i+o*(h+1),p=t[r++];if(null==p)break;p.center=d,p.middle=g,p.draw()}})}toString(t=!1){let{xLen:e}=this.board,i=[...this.stocks.values()].flat().filter(t=>t),s=0<i.length?`
`+"―".repeat(2*e)+`
`:"",r=i.map(t=>""+t).join("");if(!t)for(let a of(s="",Object.values(S.degChars)))r=r.replace(a,`
${a}持駒：${a}`);return s+r}}let gt=Object.keys(S.degChars),K=()=>({panel:null,piece:null});class ut{constructor(){this.degs={},gt.forEach(t=>this.degs[t]=K())}clear(t){this.degs[t]=K()}setTarget(t,e){t.hasTarget("start")&&e.hasAttr("enPassant")&&(this.degs[e.deg].panel=t)}setMoved(t){let{piece:e}=t,i=this.degs[e.deg];e&&t===i.panel?i.piece=e:this.clear(e.deg)}isTarget(t,e){return!t||!t.piece||!!t.piece.hasAttr("enPassant")&&t.piece===this.degs[t.piece.deg].piece}}class q{static run(t,e){let{playBoard:i,playPieces:s,onDrawed:r}=e,a=s.some(({gameName:t},e)=>1<e&&t)?4:2,o=new q(t,i,{...e,players:a,onDrawed:r});return s.forEach(({gameName:t,pieceSet:e},i)=>{if(t){e??="default";try{o.putStartPieces(i,t,e)}catch{}}}),o.onDrawed=r,o}constructor(t,e,i){let{players:s=2,canvasWidth:r,canvasHeight:a,canvasFit:o="overflow",boardLeft:h=5,boardTop:n=5,panelWidth:l=50,panelHeight:c=0|1.1*l,pieceSize:d=0|.9*l,useRankSize:g=!0,isDrawShadow:p=!0,borderWidth:$=Math.min(l,c)/30,useStand:m=!1,backgroundColor:u="#00000000",autoDrawing:w=!0,onDrawed:v,onGameOver:k=t=>alert(`プレイヤー${t+1}の敗北です。`),freeMode:y=!1}=i,P=T.importAsync(),b=I.importAsync();this.canvas=t;let R=t.getContext("2d");if(R.clearRect(0,0,t.width,t.height),this.ctx=R,this.pieces=S.getPieces(R,{size:d,useRankSize:g,isDrawShadow:p}),Object.assign(this,B[e]),![2,4].includes(s))throw Error(`players=${s}, players need 2 or 4.`);this.players=s,this.left=h,this.top=n,this.panelWidth=l,this.panelHeight=c,this.borderWidth=$,this.pieceSize=d,this.canvasBackgroundColor=u,this.field=this.field.map((t,e)=>[...t].map((t,i)=>{let s=h+l*(i+1),r=n+c*(e+1);return new nt(R,t,s,r,l,c,$,i,e)})),this.xLen=this.field[0].length,this.yLen=this.field.length,this.width=this.panelWidth*(this.xLen+1),this.height=this.panelHeight*(this.yLen+1),this.right=h+this.width,this.bottom=n+this.height,this.stand=new U(this),t.width=r??(m?this.stand.right:this.right)+5,t.height=a??this.bottom+5;let{style:C}=t;"overflow"===o?(""===C.maxWidth&&(C.maxWidth="97vw"),""===C.maxHeight&&(C.maxHeight="97vh")):"horizontal"===o?""===C.width&&(C.width="97vw"):"vertical"===o?""===C.height&&(C.height="97vh"):"parentOverflow"===o?(""===C.maxWidth&&(C.maxWidth="100%"),""===C.maxHeight&&(C.maxHeight="100%")):"parentHorizontal"===o?""===C.width&&(C.width="100%"):"parentVertical"===o&&""===C.height&&(C.height="100%"),this.autoDrawing=w,w&&(P.then(()=>this.draw()),b.then(()=>this.draw()),this.draw()),this.onDrawed=v,this.onGameOver=k,this.gameAlives=new Map([...Array(this.players).keys()].map(t=>[this.#a(t),!0])),this.freeMode=y,this.record=[],this.uiControl=ft(this),this.enPassant=new ut}close(){this.uiControl.removeEvent()}#a(h){let n=h;0<n&&n<4&&(n=0|360*n/this.players);do n=(n+360)%360;while(n<0);return n}rotateField(t){let{xLen:e,yLen:i}=this;if(0!==(t=this.#a(t))){if(![90,180,270].includes(t))throw Error(`deg=${t}, deg need multiple of 90.`);if([90,270].includes(t)){var s;if(e!==i)throw Error(`cols=${e} != rows=${i}, Not rows = cols.`);this.field=(s=this.field)[0].map((t,e)=>s.map(t=>t[e]))}[180,270].includes(t)&&this.field.reverse(),this.field.forEach(e=>{e.forEach(e=>{e.piece&&(e.piece.deg+=t)}),[90,180].includes(t)&&e.reverse()})}}putStartPieces(t,e,i="default"){let{pieces:s}=this,r=this.#a(t);this.rotateField(r);let a=N[e].position[this.xLen][i];if(!a)throw Error(`games["${e}"].position["${this.xLen}"]["${i}"]is null.`);a.forEach((t,e)=>{if(t.length<this.xLen)throw Error(t.join(""));let i=e+this.yLen-a.length;[...t].forEach((t,e)=>{if(!s[t])return;let r=s[t].clone(),a=this.field[i][e];r.center=a.center,r.middle=a.middle,a.piece=r})}),this.rotateField(-r),this.autoDrawing&&this.draw()}putNewPiece(t,e,i,s,r={}){let{displayPtn:a=0,isMoved:o=!1}=r,{pieces:h}=this,n=this.#a(s);"string"==typeof t&&(t=new S(this.ctx,h[t],{displayPtn:a,deg:n,isMoved:o}));let l=this.field[i][e];t.center=l.center,t.middle=l.middle,l.piece=t,this.autoDrawing&&this.draw()}inputPieces(t){let{field:e,pieces:i,xLen:s,yLen:r}=this,a=[t].concat([..."┏━┯┓┗┷┛┃│┠─┼┨―"],Object.values(S.degChars).map(t=>`
`+t+"持ち駒:")).reduce((t,e)=>t.replace(RegExp(e,"g"),"")).replace(/\n\n/g,`
`).replace(/　/g,"・").trim().split(/\n/).map(t=>t.match(/.{2}/g));for(let o=0;o<r;o++)for(let h=0;h<s;h++)try{let n=a[o][h],l=S.stringToPiece(i,n);l.center=e[o][h].center,l.middle=e[o][h].middle,e[o][h].piece=l}catch{e[o][h].piece=null}this.stand.clear();let c=a[r];c&&c.forEach(t=>{let e=S.stringToPiece(i,t);e&&this.stand.add(e)}),this.autoDrawing&&this.draw()}getRow(t,e,i,s=0){let{xLen:r,yLen:a}=this;return 0===(i=this.#a(i+s))?a-1-e:90===i?t:180===i?e:270===i?r-1-t:-1}getCol(t,e,i,s=0){let{xLen:r,yLen:a}=this;return 0===(i=this.#a(i+s))?t:90===i?a-1-e:180===i?r-1-t:270===i?e:-1}checkCanPromo(t){let{yLen:e}=this,{piece:i,pX:s,pY:r}=t,{deg:a}=i,[o,h]=[i.game.promoLine,i.forcePromoLine].map(t=>e-t-(0|this.promoLineOffset)),n;return{canPromo:o<=(n=this.sidePromo?Math.max(...Object.keys(S.degChars).map(t=>0|t).filter(t=>t!==a).map(t=>this.getRow(s,r,t,180))):this.getRow(s,r,a)),forcePromo:h<=n}}#b(){[...this.gameAlives].forEach(([t,e],i)=>{e&&(this.field.some(e=>e.some(({piece:e})=>e&&e.deg===t&&e.hasAttr("king")))||(this.gameAlives.set(t,!1),this.onGameOver(i)))})}#c(l,c,d,g){let{freeMode:p}=this,{piece:$}=c;if(!$.promo||$.hasAttr("promoted")||!d){this.addRecord(c,{fromPanel:l});return}do for(let[m,{name:u}]of Object.entries($.promo))if(confirm(`成りますか?
	${$.char}:${$.name}
	　↓
	${m}:${u}`)){this.addRecord(c,{fromPanel:l,end:"成"}),$.promotion(m);return}while(!p&&g);this.addRecord(c,{fromPanel:l,end:"不成"})}movePiece(t,e){let{stand:i,freeMode:s,enPassant:r}=this;if(!t||e.hasAttr("keepOut")||e.piece===t.piece||e.piece?.deg===t.piece.deg||!this.freeMode&&!e.isTarget)return;let{canPromo:a,forcePromo:o}=this.checkCanPromo(t);i.capturePiece(t.piece,e.piece,e.hasAttr("capture"),e.hasAttr("cantCapture")),e.piece=t.piece,t.piece=null;let{piece:h}=e;h.center=e.center,h.middle=e.middle,h.isMoved=!0;let n=this.checkCanPromo(e);a||=n.canPromo,o||=n.forcePromo,r.setMoved(e),this.#c(t,e,a,o),this.#b()}addRecord(t,e={}){let{fromPanel:i,end:s=""}=e,{piece:r}=t;this.record.push({to:{pX:t.pX,pY:t.pY},from:{pX:i?.pX,pY:i?.pY},deg:r.deg,pieceChar:r.char,end:s})}getTextRecord(){let t=({pX:t})=>null==t?"*":(this.xLen-t).toString(36),e=({pY:t})=>null==t?"*":(t+1).toString(36);return this.record.map(({to:i,from:s,deg:r,pieceChar:a,end:o})=>`${S.degChars[r]}${t(i)}${e(i)}${a}${o} (${t(s)}${e(s)})`).join(`
`)}draw(){let{ctx:t,canvas:e,left:i,top:s,width:r,height:a,panelWidth:o,panelHeight:h}=this;t.restore(),t.save(),t.clearRect(0,0,e.width,e.height),t.fillStyle=this.canvasBackgroundColor,t.fillRect(0,0,e.width,e.height),t.fillStyle=this.backgroundColor,t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.save(),t.translate(i,s),t.fillRect(0,0,r,a),t.strokeRect(0,0,r,a),t.translate(o/2,h/2),t.strokeRect(0,0,r-o,a-h),t.restore(),this.stand.draw(),this.field.forEach(t=>{t.forEach(t=>{t.draw()})}),this.onDrawed&&this.onDrawed(this)}get bodText(){return x.getText(this)}toString(t=!1){let{xLen:e}=this,i="",s="",r="",a="",o=`
`;return t||(i=`┏${Array(e).fill("━━").join("┯")}┓
`,s=`
┗${Array(e).fill("━━").join("┷")}┛`,r="┃",a="│",o=`
┠${Array(e).fill("──").join("┼")}┨
`),i+this.field.map(e=>r+e.map(e=>""+(e.piece??e.toString(t))).join(a)+r).join(o)+s+this.stand.toString(t)}async downloadImage(t,e){await ot(this.canvas,t,e)}}export{q as Board,S as Piece,B as boards,T as canvasFont,I as canvasImage,pt as gameSoft,N as games};