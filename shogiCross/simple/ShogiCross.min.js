let _="./json/ShogiCross/";async function L(t){return await fetch(`./json/ShogiCross/${t}.json`).then(async t=>await t.json()).catch(()=>{})}let $=await L("canvasFont"),at=await L("gameSoft"),z=await L("games"),N=await L("boards"),P=await L("panels"),W=await L("pieces"),q=await L("pieceRange"),G=await L("pieceCost"),V=()=>[...new Set([...Object.values(P).map(({displayText:t})=>t).join("")+Object.values(W).map(({display:t})=>t?t.join(""):"").join("")])].sort().join("");function Q(t){return new Promise(e=>{let i=new Image;i.src=t,i.onload=()=>e(i)})}Object.assign($,{imported:!1,names:"",async importAsync(){if(this.imported)return;let t=V(),e=new Date().getTime().toString();return this.names=$.fonts.map(t=>`"${t[0]}${e}"`).join(",")+",serif",Promise.all($.fonts.map(async([i,s])=>{let r=i.replace(/ /g,"+"),o=`https://fonts.googleapis.com/css2?family=${r}:wght@${s}&text=${t}`,a=await fetch(o);if(!a.ok)return;let h=(await a.text()).match(/url\(.+?\)/g);if(!h)throw Error("Not found font.");for(let l of h){let n=new FontFace(`${i}${e}`,l);await n.load(),document.fonts.add(n)}})).then(t=>this.imported=!0)}});let Z=[...new Set(Object.values(P).flatMap(({imgSrc:t})=>t??[]).concat(Object.values(W).flatMap(({imgSrc:t})=>t??[])))],F={imported:!1,images:{},async importAsync(){if(!this.imported)return Promise.all(Z.map(async t=>{this.images[t]=await Q(t)})).then(t=>this.imported=!0)}};class tt{#a;constructor(t,e,i,s,r,o,a,h,l){Object.assign(this,P[e]),this.ctx=t,this.center=i,this.middle=s,this.width=r,this.height=o,this.left=i-r/2,this.top=s-o/2,this.right=i+r/2,this.bottom=s+o/2,this.borderWidth=a,this.pX=h,this.pY=l,this.selectColor??="#FF000066",this.targetColor??="#00FF0066",this.piece=null,this.isSelected=!1,this.isTarget=!1,this.attr??=[]}set isSelected(t){this.#a=!this.hasAttr("keepOut")&&t}get isSelected(){return this.#a}hasAttr(t){return this.attr.includes(t)}checkRangeMouse(t,e){return this.left<=t&&t<this.right&&this.top<=e&&e<this.bottom}draw(){let{selectColor:t,targetColor:e}=this;this.drawPanel(),this.isSelected&&this.drawMask(t),this.isTarget&&this.drawMask(e),this.piece?.draw()}drawPanel(){let{ctx:t,left:e,top:i,center:s,middle:r,width:o,height:a,displayText:h,textRotate:l}=this;if(t.fillStyle=this.backgroundColor,t.strokeStyle=this.borderColor,t.lineWidth=this.borderWidth,t.save(),t.translate(e,i),t.fillRect(0,0,o,a),this.intersect?(t.lineWidth=this.borderWidth,t.beginPath(),t.moveTo(o/2,0),t.lineTo(o/2,a),t.moveTo(0,a/2),t.lineTo(o,a/2),t.closePath(),t.stroke()):t.strokeRect(0,0,o,a),t.lineWidth=this.borderWidth/2,t.beginPath(),this.borderSlashLeft&&(t.moveTo(0,0),t.lineTo(o,a)),this.borderSlashRight&&(t.moveTo(o,0),t.lineTo(0,a)),t.closePath(),t.stroke(),t.restore(),h){t.save(),t.translate(s,r),t.fillStyle=this.borderColor,t.rotate(l?l*Math.PI/180:0);let n=.6*Math.min(this.width,this.height);t.font=`${n}px ${$.names}`;let d=t.measureText(h).width;t.fillText(h,-d/2,n/2*.8),t.restore()}}drawMask(t){let{ctx:e}=this;e.fillStyle=t,e.fillRect(this.left,this.top,this.width,this.height)}toString(t=!1){return t?`｜${this.text.slice(-1).replace(/　/g,"・")}`:this.text}}class y{static size=45;static degChars={0:"▲",90:"≫",180:"▽",270:"＜"};static charDegs={};static rareRatio={KR:1,SR:.975,R:.95,UC:.925,C:.9};get rare(){return this.cost<=0?"KR":20<=this.cost?"SR":10<=this.cost?"R":5<=this.cost?"UC":"C"}static getPieces(t){let e=new Map(Object.entries(JSON.parse(JSON.stringify(W))));for(let[i,s]of e)s.attr??=[],s.unit&&(s.base=s);for(let[r,o]of e){if(!o.promo||"string"!=typeof o.promo)continue;let a=[...o.promo];for(let h of(o.promo={},a)){let l=e.get(h);l.attr.push("promoted"),l.unit="成",o.promo[h]=l,e.set(h,{...o,...l})}}[...e].forEach(([i,s],r)=>{s.id=r,s.char=i,e.set(i,new y(t,s))});let n=Object.fromEntries(e);for(let[d,c]of e)c.alias.forEach((t,e)=>{let i=c.clone(),s=[...i.display];i.displayPtn=e+1,i.display=s,i.alias[e]=d,n[t]=i});return n}static stringToPiece(t,e){if(!e)return null;let[i,s]=[...e],r=y.charDegs[i];if(!r)return null;let o=t[s].clone();return o.deg=r,o}static piecesToList(t){return Object.entries(t).sort(([t,{id:e}],[i,{id:s}])=>Math.sign(e-s))}set deg(t){this.rad=t%360*Math.PI/180}get deg(){return this.rad%360/(Math.PI/180)}get left(){return this.center-.8*this.size/2}get top(){return this.middle-this.size/2}get right(){return this.center+.8*this.size/2}get bottom(){return this.middle+this.size/2}get zoom(){return this.size/100*y.rareRatio[this.rare]}constructor(t,e,{displayPtn:i=0,deg:s=0,size:r=y.size,isMoved:o=!1}={}){Object.assign(this,e),this.ctx=t,this.display??=[""],this.imgSrc??=null,this.alias=[...this.alias??""],this.displayPtn=i,this.game=z[this.gameName],this.cost=G[this.char]??1,this.center=0,this.middle=0,this.size=r,this.deg=s,this.isRotateImg??=!0,this.isMoved=o,this.isSelected=!1,this.attr??=[];try{Object.entries(this.range).forEach(([t,e])=>{Array.isArray(e)||(this.range[t]=q[e].map(t=>[...t]))})}catch(a){throw console.error(a),e}}clone(){let{displayPtn:t,deg:e,size:i,isMoved:s}=this;return new y(this.ctx,{...this},{displayPtn:t,deg:e,size:i,isMoved:s})}turnFront(){Object.assign(this,this.base)}promotion(t){let{promo:e}=this;if(!e)throw Error(`promo=${t}, Not plomote piece.`);if(!e in e)throw Error(`promo=${t}, Plomote key is missing.`);if(this.hasAttr("promoted"))throw Error(`promo=${t}, Promoted piece.`);Object.assign(this,e[t]),this.char=t}hasAttr(t){return this.attr.includes(t)}checkRangeMouse(t,e){return this.left<=t&&t<this.right&&this.top<=e&&e<this.bottom}getRange(){let t=0|this.deg,e=JSON.parse(JSON.stringify(this.range));return Object.keys(e).forEach(i=>{if(0!==t){if(![90,180,270].includes(t))throw Error(`deg=${t}, deg need multiple of 90.`);if([90,270].includes(t)){var s;e[i]=(s=e[i])[0].map((t,e)=>s.map(t=>t[e]))}[180,270].includes(t)&&e[i].reverse(),e[i].forEach(e=>{[90,180].includes(t)&&e.reverse()})}}),e}async draw(){let t="#FF000055";this.imgSrc&&F.imported?(this.drawImage(),this.isSelected&&this.drawMaskImage(t)):(this.drawPiece(),this.isSelected&&this.drawMask(t))}drawImage(){let{ctx:t,size:e}=this,i=this.imgSrc[this.displayPtn],s=F.images[i];if(!s)return;t.save(),t.translate(this.center,this.middle),this.isRotateImg&&t.rotate(this.rad);let r,o;.9*s.width<s.height?(r=s.width/s.height*e,o=e):(r=e,o=s.height/s.width*e),t.drawImage(s,-r/2,-o/2,r,o),t.restore()}drawMaskImage(t){let{ctx:e,size:i}=this;e.fillStyle=t,e.save();let s=.9*i,r=i;e.translate(this.center,this.middle),e.fillRect(-s/2,-r/2,s,r),e.restore()}makePath(t){let{ctx:e}=this;e.translate(this.center,this.middle),e.rotate(this.rad),e.beginPath(),e.moveTo(-30*t,-40*t),e.lineTo(0*t,-50*t),e.lineTo(30*t,-40*t),e.lineTo(45*t,50*t),e.lineTo(-45*t,50*t),e.closePath()}drawPiece(){let{ctx:t,game:e,zoom:i}=this,s,r,o;this.hasAttr("promoted")?(s=e.promoteFontColor??e.fontColor??"#000000",r=e.promoteBackgroundColor??e.backgroundColor??"#FFFFFF",o=e.promoteBorderColor??e.borderColor??"#FF3300"):(s=e.fontColor??"#000000",r=e.backgroundColor??"#FFFFFF",o=e.borderColor??"#777777"),t.strokeStyle=o,t.fillStyle=r,t.lineWidth=8*i,t.save(),this.makePath(i),t.stroke(),t.fill(),t.fillStyle=s;let a=[...""+this.display[this.displayPtn]],h=40*i;t.font=`${h}px ${$.names}`,t.textAlign="center",a.forEach((e,i)=>{let s=1===a.length?h/2:i*h;t.fillText(e,0,s)}),t.restore()}drawMask(t){let{ctx:e,zoom:i}=this;e.fillStyle=t,e.save(),this.makePath(i),e.fill(),e.restore()}toString(){return y.degChars[this.deg]+this.char}}Object.entries(y.degChars).forEach(([t,e])=>{y.charDegs[e]=t});let et=[["default",{isAttack:!1}],["attack",{isAttack:!0}],["start",{isAttack:!1}],["castling",{isAttack:!1}],["enPassant",{isAttack:!0}],["palaceSlash",{isAttack:!1}],["palaceSlash",{isAttack:!0}]],st=[["O",{isOwn:!0}],["o",{}]],it=[["o"],["A",{child:["a"]}],["B",{child:["b"]}],["C",{child:["c"]}],["D",{child:["d"]}],["E",{child:["a","e"]}],["F",{child:["a","f"]}],["G",{child:["b","g"]}],["H",{child:["b","h"]}],["I",{child:["c","i"]}],["J",{child:["c","j"]}],["K",{child:["d","k"]}],["L",{child:["d","l"]}]],B=[["*",{}],["+",{jmps:1}],["|",{jmps:1,moves:1}]];for(let u=1;u<=9;u++)B.push([""+u,{moves:u}]);function rt(t){let e=[],i,s;for(let r=0;r<t.length;r++)for(let o=0;o<t[r].length;o++){let a=t[r][o];for(let[h,{isOwn:l}]of st)a===h&&(e.push({isOwn:l,oX:o,oY:r}),l&&([i,s]=[o,r]))}return e.map(t=>(t.offsetX=t.oX-i,t.offsetY=t.oY-s,t))}function ot(t,e,i,s){let{field:r,yLen:o,enPassant:a}=t;function h(t,e){return r[e]&&r[e][t]&&!r[e][t].hasAttr("keepOut")}function l(h,l,n,d="",c=!0){if(!r[n]||!r[n][l])return!1;let g=r[n][l];return!(!g||!a.isTarget(d,g,e)||e.hasAttr("inPalace")&&!g.hasAttr("palace")||0===d.indexOf("palace")&&!(g.hasAttr(d)&&r[s][i].hasAttr(d))||e.hasAttr("unCrossRiver")&&o-(0|o/2)<=t.getRow(l,n,e.deg))&&(h?!!r[n][l].piece&&(!c||e.deg!==r[n][l].piece.deg):!r[n][l].piece)}function n(t,e,r,o,a){for(let n of e)for(let d=0;d<t.length;d++)for(let c=0;c<t[d].length;c++){let[g,p]=[c+i-o,d+s-a];if(!(!h(g,p)||l(r,0|g,0|p,"",!1)||t[d][c]!==n))return!0}return!1}function d(t,i,s){let o=r[s][i];o.isTarget=!0,a.setTarget(t,o,e)}function c(t,[e,{isAttack:r}],{oX:o,oY:a,isOwn:c}){if(c)for(let[g,{child:p=[]}={}]of it)for(let f=0;f<t.length;f++)for(let m=0;m<t[f].length;m++){let[w,v]=[m+i-o,f+s-a];!h(w,v)||!l(r,w,v,e)||t[f][m]!==g||n(t,p,!1,o,a)||d(e,w,v)}}function g(t,[e,{isAttack:o}],{oX:a,oY:n,isOwn:c,offsetX:g,offsetY:p}){if(!(!c&&!l(!1,i+g,s+p)))for(let[f,{jmps:m=0,moves:w=0}={}]of B){let v=!w||0===w;for(let k=n-1;k<=n+1;k++)for(let S=a-1;S<=a+1;S++){if(t[k][S]!==f||S===a&&k===n)continue;let x=m||0,C=w||0,[b,R]=[S-a,k-n];for(let A=i,E=s;;){A+=b,E+=R;let T=A+g,M=E+p;if(!h(T,M)||!v&&0===C)break;let j=0===x;if(j&&l(o,T,M,e,j)?(C--,d(e,T,M)):m<1&&C--,r[M][T].piece&&(x--,j))break}}}}!function(){let t=e.getRange();for(let i of(t.attack??=t.default,et)){let s=i[0];if(e.isMoved&&["start","castling"].includes(s))continue;let r=t[s];if(r)for(let o of rt(r))c(r,i,o),g(r,i,o)}}()}function nt(t){let e=!1,i=[],s=null,r=null,{canvas:o}=t,a=(e,s,r=()=>{})=>{let a=window.getComputedStyle(o),h=e.target.getBoundingClientRect(),l=o.width/parseFloat(a.width),n=o.height/parseFloat(a.height);if(e.clientX)l*=e.clientX-h.left,n*=e.clientY-h.top;else if(0<e.touches.length){if(1<e.touches.length)return;l*=e.touches[0].clientX-h.left,n*=e.touches[0].clientY-h.top}else e.preventDefault(),[l,n]=i;t.field.forEach((t,e)=>t.forEach((t,i)=>s(t,l,n,i,e))),r(l,n),t.draw(),i=[l,n]},h=i=>{e=!0,a(i,(e,r,o)=>{let{piece:a,pX:h,pY:l}=e;a&&e.checkRangeMouse(r,o)&&(i.preventDefault(),a.isSelected=!0,s=e,ot(t,a,h,l))},(e,s)=>{for(let[o,a]of Object.entries(t.stand.stocks))for(let h=a.length-1;0<=h;h--)if(a[h].checkRangeMouse(e,s)){i.preventDefault(),a[h].isSelected=!0,r={deg:o,i:h};return}})},l=t=>{e&&(s||r)&&a(t,(t,e,i)=>{t.isSelected=t.checkRangeMouse(e,i)})},n=i=>{e=!1,a(i,(e,i,o)=>{e.checkRangeMouse(i,o)&&(s&&t.movePiece(s,e),r&&!e.piece&&t.stand.releasePiece(e,r))}),a(i,t=>{t.piece&&(t.piece.isSelected=!1),t.isSelected=!1,t.isTarget=!1},()=>{for(let[e,i]of Object.entries(t.stand.stocks))for(let o=i.length-1;0<=o;o--)i[o].isSelected=!1;s=null,r=null})};return o.addEventListener("mousedown",h),o.addEventListener("mousemove",l),o.addEventListener("mouseup",n),o.addEventListener("touchstart",h),o.addEventListener("touchmove",l),o.addEventListener("touchend",n),{removeEvent(){o.removeEventListener("mousedown",h),o.removeEventListener("mousemove",l),o.removeEventListener("mouseup",n),o.removeEventListener("touchstart",h),o.removeEventListener("touchmove",l),o.removeEventListener("touchend",n)}}}class I{static degId={180:0,90:1,270:2,0:3};constructor(t){this.board=t;let{top:e,right:i,bottom:s,width:r,height:o,panelWidth:a,panelHeight:h,xLen:l,yLen:n}=t;this.clear(),this.left=1.02*i,this.top=e,this.width=r/2,this.height=o,this.right=this.left+this.width,this.bottom=s,this.pitchWidth=a/2,this.pitchHeight=h,this.xLen=l,this.yLen=n}clear(){this.stocks=[void 0,void 0,void 0,void 0].map(t=>[])}releasePiece(t,{deg:e,i:i}){let{board:s}=this,r=this.stocks[e];t.piece=r[i],r[i].center=t.center,r[i].middle=t.middle,s.addRecord(t,{end:"打"}),r.splice(i,1)}add(t){let e=this.stocks[I.degId[t.deg]];t.turnFront(),e.push(t),e.sort((t,e)=>Math.sign(t.id-e.id))}capturePiece(t,e,i=!1,s=!1){s||!e||!(i||t.hasAttr("capture"))||e.hasAttr("king")||e.hasAttr("cantCapture")||(e.deg=t.deg,e.isMoved=!0,this.add(e))}draw(){let{board:t,left:e,top:i,width:s,height:r,pitchWidth:o,pitchHeight:a}=this,{ctx:h,xLen:l,yLen:n}=t;h.fillStyle=t.backgroundColor,h.strokeStyle=t.borderColor,h.lineWidth=t.borderWidth,h.save(),h.translate(e,i),h.fillRect(0,0,s,r),h.strokeRect(0,0,s,r),h.restore(),this.stocks.forEach((t,s)=>{let r=0;t=t.slice(-n/4*l);for(let h=0|n/4*s;h<n/4*(s+1);h++)for(let d=0;d<l;d++){let c=e+o*(d+1),g=i+a*(h+1),p=t[r++];if(null==p)break;p.center=c,p.middle=g,p.draw()}})}toString(t=!1){let{xLen:e}=this.board,i=this.stocks.flat().filter(t=>t),s=0<i.length?`
`+"―".repeat(2*e)+`
`:"",r=i.map(t=>""+t).join("");if(!t)for(let o of(s="",Object.values(y.degChars)))r=r.replace(o,`
${o}持ち駒:${o}`);return s+r}}let ct=Object.keys(y.degChars),Y=()=>({panel:null,piece:null});class ht{constructor(){this.degs={},ct.forEach(t=>this.degs[t]=Y())}clear(t){this.degs[t]=Y()}setTarget(t,e,i){"start"===t&&i.hasAttr("enPassant")&&(this.degs[i.deg].panel=e)}setMoved(t){let{piece:e}=t,i=this.degs[e.deg];e&&t===i.panel?i.piece=e:this.clear(e.deg)}isTarget(t,e,i){return!e||!e.piece||"enPassant"!==t||!!e.piece.hasAttr("enPassant")&&e.piece===this.degs[e.piece.deg].piece}}class J{static run(t,e){let{playBoard:i,playPieces:s,onDrawed:r}=e,o=s.some(({gameName:t},e)=>1<e&&t)?4:2,a=new J(t,i,{...e,players:o,onDrawed:r});return s.forEach(({gameName:t,pieceSet:e},i)=>{if(t){e??="default";try{a.putStartPieces(i,t,e)}catch{}}}),a.onDrawed=r,a}constructor(t,e,{players:i=2,canvasWidth:s,canvasHeight:r,canvasFit:o="overflow",boardLeft:a=5,boardTop:h=5,panelWidth:l=50,panelHeight:n=0|1.1*l,pieceSize:d=0|.9*l,useStand:c=!1,backgroundColor:g="#00000000",autoDrawing:p=!0,onDrawed:f,freeMode:m=!1}={}){let w=$.importAsync(),v=F.importAsync();this.canvas=t;let k=t.getContext("2d");if(k.clearRect(0,0,t.width,t.height),this.ctx=k,y.size=d,this.pieces=y.getPieces(k,d),Object.assign(this,N[e]),![2,4].includes(i))throw Error(`players=${i}, players need 2 or 4.`);this.players=i,this.left=a,this.top=h,this.panelWidth=l,this.panelHeight=n,this.pieceSize=d,this.canvasBackgroundColor=g,this.field=this.field.map((t,e)=>[...t].map((t,i)=>{let s=a+l*(i+1),r=h+n*(e+1);return new tt(k,t,s,r,l,n,this.borderWidth,i,e)})),this.xLen=this.field[0].length,this.yLen=this.field.length,this.width=this.panelWidth*(this.xLen+1),this.height=this.panelHeight*(this.yLen+1),this.right=a+this.width,this.bottom=h+this.height,this.stand=new I(this),t.width=s??(c?this.stand.right:this.right)+5,t.height=r??this.bottom+5;let{style:S}=t;"overflow"===o?(""===S.maxWidth&&(S.maxWidth="97vw"),""===S.maxHeight&&(S.maxHeight="97vh")):"horizontal"===o?""===S.width&&(S.width="97vw"):"vertical"===o?""===S.height&&(S.height="97vh"):"parentOverflow"===o?(""===S.maxWidth&&(S.maxWidth="100%"),""===S.maxHeight&&(S.maxHeight="100%")):"parentHorizontal"===o?""===S.width&&(S.width="100%"):"parentVertical"===o&&""===S.height&&(S.height="100%"),this.autoDrawing=p,p&&(w.then(()=>this.draw()),v.then(()=>this.draw()),this.draw()),this.onDrawed??=f,this.freeMode=m,this.record=[],this.uiControl=nt(this),this.enPassant=new ht}close(){this.uiControl.removeEvent()}rotateField(t){let{xLen:e,yLen:i}=this;do t=(t+360)%360;while(t<0);if(0!==t){if(![90,180,270].includes(t))throw Error(`deg=${t}, deg need multiple of 90.`);if([90,270].includes(t)){var s;if(e!==i)throw Error(`cols=${e} != rows=${i}, Not rows = cols.`);this.field=(s=this.field)[0].map((t,e)=>s.map(t=>t[e]))}[180,270].includes(t)&&this.field.reverse(),this.field.forEach(e=>{e.forEach(e=>{e.piece&&(e.piece.deg+=t)}),[90,180].includes(t)&&e.reverse()})}}putStartPieces(t,e,i="default"){let{pieces:s}=this,r=0|360*t/this.players;this.rotateField(r);let o=z[e].position[this.xLen][i];if(!o)throw Error(`games["${e}"].position["${this.xLen}"]["${i}"]is null.`);o.forEach((t,e)=>{if(t.length<this.xLen)throw Error(t.join(""));let i=e+this.yLen-o.length;[...t].forEach((t,e)=>{if(!s[t])return;let r=s[t].clone(),o=this.field[i][e];r.center=o.center,r.middle=o.middle,o.piece=r})}),this.rotateField(-r),this.autoDrawing&&this.draw()}putNewPiece(t,e,i,s,{displayPtn:r=0,setDeg:o=!1,isMoved:a=!1}={}){let{pieces:h}=this;"string"==typeof t&&(t=new y(this.ctx,h[t],{displayPtn:r,deg:o?s:90*s,isMoved:a}));let l=this.field[i][e];t.center=l.center,t.middle=l.middle,l.piece=t,this.autoDrawing&&this.draw()}inputPieces(t){let{field:e,pieces:i,xLen:s,yLen:r}=this,o=[t].concat([..."┏━┯┓┗┷┛┃│┠─┼┨―"],Object.values(y.degChars).map(t=>`
`+t+"持ち駒:")).reduce((t,e)=>t.replace(RegExp(e,"g"),"")).replace(/\n\n/g,`
`).replace(/　/g,"・").trim().split(/\n/).map(t=>t.match(/.{2}/g));for(let a=0;a<r;a++)for(let h=0;h<s;h++)try{let l=o[a][h],n=y.stringToPiece(i,l);n.center=e[a][h].center,n.middle=e[a][h].middle,e[a][h].piece=n}catch{e[a][h].piece=null}this.stand.clear();let d=o[r];d&&d.forEach(t=>{let e=y.stringToPiece(i,t);e&&this.stand.add(e)}),this.autoDrawing&&this.draw()}getRow(t,e,i,s=0){let{xLen:r,yLen:o}=this;i+=s;do i=(i+360)%360;while(i<0);return 0===i?o-1-e:90===i?t:180===i?e:270===i?r-1-t:-1}getCol(t,e,i,s=0){let{xLen:r,yLen:o}=this;i+=s;do i=(i+360)%360;while(i<0);return 0===i?t:90===i?o-1-e:180===i?r-1-t:270===i?e:-1}checkCanPromo(t){let{yLen:e}=this,{piece:i,pX:s,pY:r}=t,{deg:o}=i,[a,h]=[i.game.promoLine,i.forcePromoLine].map(t=>e-t-(0|this.promoLineOffset)),l;return{canPromo:a<=(l=this.sidePromo?Math.max(...Object.keys(y.degChars).map(t=>0|t).filter(t=>t!==o).map(t=>this.getRow(s,r,t,180))):this.getRow(s,r,o)),forcePromo:h<=l}}movePiece(t,e){let{stand:i,freeMode:s,enPassant:r}=this;if(!t||e.hasAttr("keepOut")||e.piece===t.piece||e.piece?.deg===t.piece.deg||!this.freeMode&&!e.isTarget)return;let{canPromo:o,forcePromo:a}=this.checkCanPromo(t);i.capturePiece(t.piece,e.piece,e.hasAttr("capture"),e.hasAttr("cantCapture")),e.piece=t.piece,t.piece=null;let{piece:h}=e;h.center=e.center,h.middle=e.middle,h.isMoved=!0;let l=this.checkCanPromo(e);if(o||=l.canPromo,a||=l.forcePromo,r.setMoved(e),!h.promo||h.hasAttr("promoted")||!o){this.addRecord(e,{fromPanel:t});return}do for(let[n,{name:d}]of Object.entries(h.promo))if(confirm(`成りますか?
	${h.char}:${h.name}
	　↓
	${n}:${d}`)){this.addRecord(e,{fromPanel:t,end:"成"}),h.promotion(n);return}while(!s&&a);this.addRecord(e,{fromPanel:t,end:"不成"})}addRecord(t,{fromPanel:e,end:i=""}={}){let{piece:s}=t;this.record.push({to:{pX:t.pX,pY:t.pY},from:{pX:e?.pX,pY:e?.pY},deg:s.deg,pieceChar:s.char,end:i})}getTextRecord(){let t=({pX:t})=>null==t?"*":(this.xLen-t).toString(36),e=({pY:t})=>null==t?"*":(t+1).toString(36);return this.record.map(({to:i,from:s,deg:r,pieceChar:o,end:a})=>`${y.degChars[r]}${t(i)}${e(i)}${o}${a} (${t(s)}${e(s)})`).join(`
`)}draw(){let{ctx:t,canvas:e,left:i,top:s,width:r,height:o,panelWidth:a,panelHeight:h}=this;t.restore(),t.save(),t.clearRect(0,0,e.width,e.height),t.fillStyle=this.canvasBackgroundColor,t.fillRect(0,0,e.width,e.height),t.fillStyle=this.backgroundColor,t.lineWidth=this.borderWidth,t.strokeStyle=this.borderColor,t.save(),t.translate(i,s),t.fillRect(0,0,r,o),t.strokeRect(0,0,r,o),t.translate(a/2,h/2),t.strokeRect(0,0,r-a,o-h),t.restore(),this.stand.draw(),this.field.forEach(t=>{t.forEach(t=>{t.draw()})}),this.onDrawed&&this.onDrawed(this)}toString(t=!1){let{xLen:e}=this,i="",s="",r="",o="",a=`
`;return t||(i=`┏${Array(e).fill("━━").join("┯")}┓
`,s=`
┗${Array(e).fill("━━").join("┷")}┛`,r="┃",o="│",a=`
┠${Array(e).fill("──").join("┼")}┨
`),i+this.field.map(e=>r+e.map(e=>""+(e.piece||e.toString(t))).join(o)+r).join(a)+s+this.stand.toString(t)}}export{J as Board,y as Piece,N as boards,$ as canvasFont,F as canvasImage,at as gameSoft,z as games};