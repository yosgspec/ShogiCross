<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width" />
		<title>将棋駒画像生成 - ShogiCross</title>
		<link rel=icon href="img/favicon.min.svg">
		<link href="shogicross.css" rel="stylesheet">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Kosugi&family=Noto+Serif+JP:wght@900&family=Noto+Serif+TC:wght@900&family=Noto+Serif:wght@900&family=Kosugi:wght@400&display=swap" rel="stylesheet">
	</head>
	<body>
			<h1>ShogiCross 将棋駒画像生成</h1>
		<div class="flex-col">
			Size:
			<div class="flex-row">
				<input id="pieceSize" style="width: 4em;" value="1000">px
			</div>
			<button onclick="makeImage()">画像生成</button>
			<canvas id="pieceViewer"></canvas>
		</div>
		<script src="./dist/ShogiCross.iife.min.js"></script>
		<script>
		const getMime = (ext)=>
			"image/"+ext.replace("jpg", "jpeg");

		/** キャンバスの画像を取得する
		 * @param {HTMLCanvasElement}} canvas - Canvas要素
		 * @param {string} fileName - 取得するファイル名(拡張子を除く)
		 * @param {string} ext - 拡張子
		 * @param {"base64"|"blob"} urlType - 生成URLタイプ
		 * @returns {Promise<void>}
		 */
		async function downloadImage(canvas, fileName="image", ext="png", urlType="base64"){
			const mime = getMime(ext);
			const a = document.createElement("a");
			let url;
			if(urlType === "blob")
				url = URL.createObjectURL(
					await new Promise(res=>canvas.toBlob(res), mime));
			else
				url = canvas.toDataURL(mime);
			a.href = url;
			a.download = `${fileName}.${ext}`;
			a.click();
			if(urlType === "blob") URL.revokeObjectURL(a.href);
		}
		</script>
		<script>
		const {canvasFont, Piece} = ShogiCross;
		const canvas = document.getElementById("pieceViewer");
		const ctx = canvas.getContext("2d");
		const pieceSize = document.getElementById("pieceSize");

		const pieces = Piece.getPieces(ctx, {
			size: 100,
			isDrawShadow: false
		});
		console.log(pieces);
		async function makeImage(){
			let size = +pieceSize.value;
			if(isNaN(size) || !pieceSize.value) size = 1000;
			await canvasFont.importAsync();
			let i=0;
			for(let [key ,piece] of Object.entries(pieces)){
				if(piece.gameName === "てがきちぇす") continue;
				canvas.width = size;
				canvas.height = size;
				ctx.clearRect(0, 0, size, size);
				piece.center = size/2;
				piece.middle = size/2;
				piece.size = size*0.9;
				piece.attr = [];
				piece.draw();
				await downloadImage(canvas, `${i++}${key}`, "png", "blob");
				await new Promise(res=>setTimeout(res, 500));
			}
		};
		</script>
	</body>
</html>
