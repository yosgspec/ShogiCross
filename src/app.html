<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width" />
		<title>ShogiCross</title>
		<link rel=icon href="sample/img/favicon.min.svg">
		<link href="shogicross.css" rel="stylesheet">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@900&family=Kosugi:wght@400&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
		<link rel="manifest" href="manifest.json" />
		<script defer src="./game/pwa.js"></script>
	</head>
	<body>
		<div class="flex-col">
			<div class="flex-col-fit">
				<input id="onlineMsg" style="display:none; width:99%;" readonly>
				<div><canvas id="shogiCross"></canvas></div>
				<div class="flex-row">
					<select id="selectGame"></select>
					<select id="selectVariant" style="flex-grow:1"></select>
					<button id="toggleOnline"></button>
				</div>
			</div>
			<div id="crossSelects" class="flex-row">
				<div class="flex-col-fit">
					<select id="selectBoard"></select>
					<select id="selectStand">
						<option value="true">駒台あり</option>
						<option value="false">駒台なし</option>
					</select>
					<select id="selectMoveMode">
						<option value="free">自由移動モード</option>
						<option value="normal">範囲移動モード</option>
						<option value="vs">手番限定モード</option>
						<option value="viewOnly">棋譜再生モード</option>
					</select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
					<select class="selectCpuEngine"></select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
					<select class="selectCpuEngine"></select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
					<select class="selectCpuEngine"></select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
					<select class="selectCpuEngine"></select>
				</div>
			</div>
			<details open>
				<summary>棋譜</summary>
				<div class="flex-col-fit">
					<textarea id="recordText" style="height:100px; overflow-y:scroll;" readonly></textarea>
					<div class="flex-row">
						<input id="recordJson" class="mono" placeholder="棋譜データを入出力">
						<button id="recordJsonCopy" title="棋譜データをクリップボードへコピー">コピー</button>
						<button id="recordJsonInput" title="棋譜データを盤面に反映">反映</button>
						<button id="recordJsonOutput" title="棋譜データを盤面から取得">取得</button>
					</div>
				</div>
			</details>
			<details>
				<summary>テキスト/BOD形式表示</summary>
				テキストを直接書き換えて駒配置を直接編集できます。<br>
				配置可能な駒は<a href="https://github.com/yosgspec/ShogiCross/blob/main/doc/pieces/README.md">駒情報表</a>を参照してください。<br>
				<div class="flex-row">
					<input type="radio" name="selectBoardText" value="default" checked id="selectBoardTextDefault">
					<label for="selectBoardTextDefault">標準</label>
					<input type="radio" name="selectBoardText" value="compact" id="selectBoardTextCompact">
					<label for="selectBoardTextCompact">コンパクト</label>
					<input type="radio" name="selectBoardText" value="bod" id="selectBoardTextBod">
					<label for="selectBoardTextBod">BOD形式</label>
				</div>
				<textarea id="shogiCrossText"></textarea>
			</details>
		</div>
		<script type="module">
		import {boardRun} from "./game/playGame.js";
		import {SelectControl} from "./game/selectControl.js";
		import {Board} from "./ShogiCross/lib.js";
		const canvas = document.getElementById("shogiCross");
		const selectVariant = document.getElementById("selectVariant");
		const recordText = document.getElementById("recordText");
		const recordJson = document.getElementById("recordJson");
		const recordJsonCopy = document.getElementById("recordJsonCopy");
		const recordJsonInput = document.getElementById("recordJsonInput");
		const recordJsonOutput = document.getElementById("recordJsonOutput");
		const selectBoardText = document.getElementsByName("selectBoardText");
		const txt = document.getElementById("shogiCrossText");
		canvas.addEventListener("shogicross:reload", playGame);

		/** @type {Board} 実行中のゲーム */
		let board = null;

		/** 描写イベント
		 * @param {Board} board
		 */
		function onDrawed(board){
			recordText.value = board.record.getTextAll();
			recordText.scrollTop = recordText.scrollHeight;

			for(const {checked, value:mode} of selectBoardText){
				if(!checked) continue;

				txt.value = board.getPiecesText(mode);
				const txtSplit = txt.value.split(/\n/);
				const fontSize = parseFloat(window.getComputedStyle(txt, null).getPropertyValue('font-size'));
				txt.style.height = `${0|fontSize*txtSplit.length*1.1}px`;
				if(mode!=="bod"){
					txt.style.width = `${0|fontSize*txtSplit[0].length*1.15}px`;
					txt.classList.remove("mono");
				}
				else{
					txt.style.width = "500px";
					txt.classList.add("mono");
				}
				break;
			};
		};

		/** テキスト更新イベント
		 * @param {HTMLElement} target
		 */
		function txtOnChange({target}){
			board.setPiecesText(target.value);
		};

		/** ゲームを実行 */
		async function playGame(){
			board?.close();
			board = boardRun(canvas, {onDrawed, ...SelectControl.option});
			txt.onchange = txtOnChange;
			recordJsonCopy.onclick = ()=>
				navigator.clipboard.writeText(recordJson.value).then(()=>recordJson.select());
			recordJsonInput.onclick = ()=>
				board.record.setJson(recordJson.value);
			recordJsonOutput.onclick = ()=>
				recordJson.value = board.record.getJson();
		};

		(function(){
			playGame();
			SelectControl.onChange = playGame;
			[...selectBoardText].forEach(
				e=>e.onchange=()=>onDrawed(board));
		})();
		</script>
	</body>
</html>
