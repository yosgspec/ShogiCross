<!DOCTYPE html>
<html>
	<head>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-46760069-2"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'UA-46760069-2');
		</script>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width" />
		<title>ShogiCross</title>
		<link rel=icon href="img/favicon.min.svg">
		<link href="shogicross.css" rel="stylesheet">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@900&family=Kosugi:wght@400&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
	</head>
	<body>
		<div class="flex-col">
			<canvas id="shogiCross"></canvas>
			<div class="flex-row">
				<select id="selectGame"></select>
				<select id="selectVariant"></select>
				<div class="flex-row">
					<button id="undoGame" title="ä¸€æ‰‹æˆ»ã‚‹">&lt;&lt;</button>
					<button id="redoGame" title="ä¸€æ‰‹é€²ã‚€">&gt;&gt;</button>
					<button id="rotateLeft" title="ç›¤é¢ã‚’å·¦å›è»¢">ğŸ”„</button>
					<button id="rotateRight" title="ç›¤é¢ã‚’å³å›è»¢">ğŸ”</button>
					<button id="downloadImage" title="ç”»åƒã‚’ä¿å­˜">ğŸ“·</button>
				</div>
			</div>
			<div id="crossSelects" class="flex-row" style="display:none">
				<div class="flex-col-fit">
					<select id="selectBoard"></select>
					<select id="selectStand">
						<option value="true">é§’å°ã‚ã‚Š</option>
						<option value="false">é§’å°ãªã—</option>
					</select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
				</div>
				<div class="flex-col-fit">
					<select class="selectPieceGame"></select>
					<select class="selectPieceSet"></select>
				</div>
			</div>
			<details open>
				<summary >æ£‹è­œ</summary>
				<div class="flex-col-fit">
					<textarea id="recordText" style="height:100px; overflow-y:scroll;" readonly></textarea>
					<div class="flex-row">
						<input id="recordJson" class="mono" placeholder="æ£‹è­œãƒ‡ãƒ¼ã‚¿ã‚’å…¥å‡ºåŠ›">
						<button id="recordJsonCopy" title="æ£‹è­œãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼">ã‚³ãƒ”ãƒ¼</button>
						<button id="recordJsonInput" title="æ£‹è­œãƒ‡ãƒ¼ã‚¿ã‚’ç›¤é¢ã«åæ˜ ">åæ˜ </button>
						<button id="recordJsonOutput" title="æ£‹è­œãƒ‡ãƒ¼ã‚¿ã‚’ç›¤é¢ã‹ã‚‰å–å¾—">å–å¾—</button>
					</div>
				</div>

			</details>
			<details>
				<summary>ãƒ†ã‚­ã‚¹ãƒˆ/BODå½¢å¼è¡¨ç¤º</summary>
				ãƒ†ã‚­ã‚¹ãƒˆã‚’ç›´æ¥æ›¸ãæ›ãˆã¦é§’é…ç½®ã‚’ç›´æ¥ç·¨é›†ã§ãã¾ã™ã€‚<br>
				é…ç½®å¯èƒ½ãªé§’ã¯<a href="https://github.com/yosgspec/ShogiCross/blob/main/doc/pieces/README.md">é§’æƒ…å ±è¡¨</a>ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚<br>
				<div class="flex-row">
					<input type="radio" name="selectBoardText" value="default" checked id="selectBoardTextDefault">
					<label for="selectBoardTextDefault">æ¨™æº–</label>
					<input type="radio" name="selectBoardText" value="compact" id="selectBoardTextCompact">
					<label for="selectBoardTextCompact">ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ</label>
					<input type="radio" name="selectBoardText" value="bod" id="selectBoardTextBod">
					<label for="selectBoardTextBod">BODå½¢å¼</label>
				</div>
				<textarea id="shogiCrossText"></textarea>
			</details>
		</div>
		<script type="module">
		import {PlayGames} from "./game/playGame.js";
		import {SelectControl} from "./game/selectControl.js";
		const canvas = document.getElementById("shogiCross");
		const downloadImage = document.getElementById("downloadImage");
		const rotateLeft = document.getElementById("rotateLeft");
		const rotateRight = document.getElementById("rotateRight");
		const undoGame = document.getElementById("undoGame");
		const redoGame = document.getElementById("redoGame");
		const recordText = document.getElementById("recordText");
		const recordJson = document.getElementById("recordJson");
		const recordJsonCopy = document.getElementById("recordJsonCopy");
		const recordJsonInput = document.getElementById("recordJsonInput");
		const recordJsonOutput = document.getElementById("recordJsonOutput");
		const selectBoardText = document.getElementsByName("selectBoardText")
		const txt = document.getElementById("shogiCrossText");

		/** æå†™ã‚¤ãƒ™ãƒ³ãƒˆ
		 * @param {Board} e
		 */
		function onDrawed(e){
			recordText.value = e.getTextRecord();
			recordText.scrollTop = recordText.scrollHeight;

			for(const {checked, value:mode} of selectBoardText){
				if(!checked) continue;

				txt.value = e.getTextPieces(mode);
				const txtSplit = txt.value.split(/\n/);
				const fontSize = parseFloat(window.getComputedStyle(txt, null).getPropertyValue('font-size'));
				txt.style.height = `${0|fontSize*txtSplit.length*1.1}px`;
				if(mode!=="bod"){
					txt.style.width = `${0|fontSize*txtSplit[0].length*1.15}px`;
					txt.classList.remove("mono");
				}
				else{
					txt.style.width = "500px";
					txt.classList.add("mono");
				}
				break;
			};
		};

		/** ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
		 * @param {HTMLElement} target
		 */
		 function txtOnChange({target}){
			playingGame.setTextPieces(target.value);
		};

		/** ç”»åƒã‚’ä¿å­˜ãƒœã‚¿ãƒ³ */
		 function downloadImageClick(){
			playingGame.downloadImage(SelectControl.gameName);
		}

		/** å®Ÿè¡Œä¸­ã®ã‚²ãƒ¼ãƒ 
		 * @type {Board}
		 */
		let playingGame = {};

		/** ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œ */
		async function playGame(){
			if(playingGame.close) playingGame.close();
			playingGame = PlayGames[SelectControl.gameName].run(canvas, {onDrawed, ...SelectControl.option});
			downloadImage.onclick = downloadImageClick;
			txt.onchange = txtOnChange;
			rotateLeft.onclick = ()=>playingGame.rotate(false);
			rotateRight.onclick = ()=>playingGame.rotate();
			undoGame.onclick = ()=>playingGame.undoRecord();
			redoGame.onclick = ()=>playingGame.redoRecord();
			recordJsonCopy.onclick = ()=>navigator.clipboard.writeText(recordJson.value).then(()=>recordJson.select());
			recordJsonInput.onclick = ()=>playingGame.setJsonRecord(recordJson.value);
			recordJsonOutput.onclick = ()=>recordJson.value = playingGame.getJsonRecord();
		};

		(function(){
			playGame();
			SelectControl.onchange = playGame;
			[...selectBoardText].forEach(
				e=>e.onchange=()=>onDrawed(playingGame))
		})();
		</script>
	</body>
</html>
